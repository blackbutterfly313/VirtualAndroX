name: 🚀 Build VirtualAndroX APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Checkout code
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 📦 Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          wget \
          unzip \
          openjdk-11-jdk \
          zip \
          python3-pip \
          libffi-dev \
          libssl-dev \
          python3-dev \
          build-essential

    - name: 🔧 Install Android SDK (FIXED)
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O /tmp/cmdline-tools.zip
        mkdir -p android-sdk/cmdline-tools/latest
        unzip -q /tmp/cmdline-tools.zip -d /tmp/
        mv /tmp/cmdline-tools/* android-sdk/cmdline-tools/latest/
        rm /tmp/cmdline-tools.zip

    - name: ✅ Setup Android Environment
      run: |
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "$GITHUB_WORKSPACE/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH

    - name: 📝 Accept Android Licenses
      run: |
        yes | $GITHUB_WORKSPACE/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses --sdk_root=$GITHUB_WORKSPACE/android-sdk

    - name: 🔨 Install Android Tools
      run: |
        $GITHUB_WORKSPACE/android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-30" \
          "build-tools;30.0.3" \
          --sdk_root=$GITHUB_WORKSPACE/android-sdk

    - name: ⚙️ Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0
        pip install cython==0.29.33

    - name: 🏗️ Build VirtualAndroX APK
      run: |
        buildozer -v android debug

    - name: 📤 Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: VirtualAndroX-APK
        path: bin/*.apk
        retention-days: 30

    - name: 🏷️ Create GitHub Release
      if: success() && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        tag_name: v${{ github.run_number }}
        name: VirtualAndroX v${{ github.run_number }}
        body: |
          🎉 **VirtualAndroX APK Successfully Built!**
          
          **Features:**
          - ✅ Android 11 Virtualization Environment
          - ✅ myBSN Banking App Compatibility  
          - ✅ Huawei Nova 4 Optimized
          - ✅ No Google Services Required
          
          **Build Details:**
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          - Commit: ${{ github.sha }}

    - name: 📱 Build Success Notification
      if: success()
      run: |
        echo "🎉 VIRTUALANDROX APK BUILT SUCCESSFULLY!"
        echo "📱 Download from: https://github.com/${{ github.repository }}/releases"
